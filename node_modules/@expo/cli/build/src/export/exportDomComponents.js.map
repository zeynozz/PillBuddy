{"version":3,"sources":["../../../src/export/exportDomComponents.ts"],"sourcesContent":["import type { ExpoConfig } from '@expo/config';\nimport assert from 'assert';\nimport crypto from 'crypto';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\n\nimport { type PlatformMetadata } from './createMetadataJson';\nimport { type BundleOutput, type ExportAssetMap, getFilesFromSerialAssets } from './saveAssets';\nimport { type MetroBundlerDevServer } from '../start/server/metro/MetroBundlerDevServer';\nimport { serializeHtmlWithAssets } from '../start/server/metro/serializeHtml';\nimport {\n  getDomComponentHtml,\n  DOM_COMPONENTS_BUNDLE_DIR,\n} from '../start/server/middleware/DomComponentsMiddleware';\nimport { env } from '../utils/env';\nimport { resolveRealEntryFilePath } from '../utils/filePath';\n\nconst debug = require('debug')('expo:export:exportDomComponents') as typeof console.log;\n\n// TODO(EvanBacon): determine how to support DOM Components with hosting.\nexport async function exportDomComponentAsync({\n  filePath,\n  projectRoot,\n  dev,\n  devServer,\n  isHermes,\n  includeSourceMaps,\n  exp,\n  files,\n}: {\n  filePath: string;\n  projectRoot: string;\n  dev: boolean;\n  devServer: MetroBundlerDevServer;\n  isHermes: boolean;\n  includeSourceMaps: boolean;\n  exp: ExpoConfig;\n  files: ExportAssetMap;\n}): Promise<{\n  bundle: BundleOutput;\n  htmlOutputName: string;\n}> {\n  const virtualEntry = resolveFrom(projectRoot, 'expo/dom/entry.js');\n  debug('Bundle DOM Component:', filePath);\n  // MUST MATCH THE BABEL PLUGIN!\n  const hash = crypto.createHash('sha1').update(filePath).digest('hex');\n  const outputName = `${DOM_COMPONENTS_BUNDLE_DIR}/${hash}.html`;\n  const generatedEntryPath = filePath.startsWith('file://') ? filePath.slice(7) : filePath;\n  const baseUrl = `/${DOM_COMPONENTS_BUNDLE_DIR}`;\n  const relativeImport = './' + path.relative(path.dirname(virtualEntry), generatedEntryPath);\n  // Run metro bundler and create the JS bundles/source maps.\n  const bundle = await devServer.legacySinglePageExportBundleAsync({\n    platform: 'web',\n    domRoot: encodeURI(relativeImport),\n    splitChunks: !env.EXPO_NO_BUNDLE_SPLITTING,\n    mainModuleName: resolveRealEntryFilePath(projectRoot, virtualEntry),\n    mode: dev ? 'development' : 'production',\n    engine: isHermes ? 'hermes' : undefined,\n    serializerIncludeMaps: includeSourceMaps,\n    bytecode: false,\n    reactCompiler: !!exp.experiments?.reactCompiler,\n    baseUrl: './',\n    // Minify may be false because it's skipped on native when Hermes is enabled, default to true.\n    minify: true,\n  });\n\n  const html = await serializeHtmlWithAssets({\n    isExporting: true,\n    resources: bundle.artifacts,\n    template: getDomComponentHtml(),\n    baseUrl: './',\n  });\n\n  const serialAssets = bundle.artifacts.map((a) => {\n    return {\n      ...a,\n      filename: path.join(baseUrl, a.filename),\n    };\n  });\n\n  getFilesFromSerialAssets(serialAssets, {\n    includeSourceMaps,\n    files,\n    platform: 'web',\n  });\n\n  files.set(outputName, {\n    contents: html,\n  });\n\n  return {\n    bundle,\n    htmlOutputName: outputName,\n  };\n}\n\n/**\n * For EAS Updates exports,\n * post-processes the DOM component bundle and updates the asset paths to use flattened MD5 naming.\n */\nexport function updateDomComponentAssetsForMD5Naming({\n  domComponentReference,\n  nativeBundle,\n  domComponentBundle,\n  files,\n  htmlOutputName,\n}: {\n  domComponentReference: string;\n  nativeBundle: BundleOutput;\n  domComponentBundle: BundleOutput;\n  files: ExportAssetMap;\n  htmlOutputName: string;\n}): PlatformMetadata['assets'] {\n  const assetsMetadata: PlatformMetadata['assets'] = [];\n\n  for (const artifact of domComponentBundle.artifacts) {\n    if (artifact.type !== 'js') {\n      continue;\n    }\n    const artifactAssetName = `/${DOM_COMPONENTS_BUNDLE_DIR}/${artifact.filename}`;\n    let source = artifact.source;\n\n    // [0] Updates asset paths in the DOM component JS bundle (which is a web bundle)\n    for (const asset of domComponentBundle.assets) {\n      const prefix = asset.httpServerLocation.startsWith('./')\n        ? asset.httpServerLocation.slice(2)\n        : asset.httpServerLocation;\n      const uri = `${prefix}/${asset.name}.${asset.type}`;\n      const regexp = new RegExp(`(uri:\")(${uri})(\")`, 'g');\n      const index = asset.scales.findIndex((s) => s === 1) ?? 0; // DOM components (web) uses 1x assets\n      const md5 = asset.fileHashes[index];\n      source = source.replace(regexp, `$1${md5}.${asset.type}$3`);\n\n      const domJsAssetEntity = files.get(artifactAssetName);\n      assert(domJsAssetEntity);\n      domJsAssetEntity.contents = source;\n    }\n\n    // [1] Updates JS artifacts in HTML\n    const md5 = crypto.createHash('md5').update(source).digest('hex');\n    const htmlAssetEntity = files.get(htmlOutputName);\n    assert(htmlAssetEntity);\n    const regexp = new RegExp(`(<script src=\")(.*${artifact.filename})(\" defer></script>)`, 'g');\n    htmlAssetEntity.contents = htmlAssetEntity.contents.toString().replace(regexp, `$1${md5}.js$3`);\n\n    assetsMetadata.push({\n      path: artifactAssetName.slice(1),\n      ext: 'js',\n    });\n  }\n\n  // [2] Updates HTML names from native bundle\n  const htmlContent = files.get(htmlOutputName);\n  assert(htmlContent);\n  const htmlMd5 = crypto.createHash('md5').update(htmlContent.contents.toString()).digest('hex');\n  const hash = crypto.createHash('sha1').update(domComponentReference).digest('hex');\n  for (const artifact of nativeBundle.artifacts) {\n    if (artifact.type !== 'js') {\n      continue;\n    }\n    const assetEntity = files.get(artifact.filename);\n    assert(assetEntity);\n    const regexp = new RegExp(`(['\"])${hash}\\\\.html(['\"])`, 'g');\n    assetEntity.contents = assetEntity.contents.toString().replace(regexp, `$1${htmlMd5}.html$2`);\n  }\n  assetsMetadata.push({\n    path: htmlOutputName,\n    ext: 'html',\n  });\n\n  return assetsMetadata;\n}\n"],"names":["exportDomComponentAsync","updateDomComponentAssetsForMD5Naming","debug","require","filePath","projectRoot","dev","devServer","isHermes","includeSourceMaps","exp","files","virtualEntry","resolveFrom","hash","crypto","createHash","update","digest","outputName","DOM_COMPONENTS_BUNDLE_DIR","generatedEntryPath","startsWith","slice","baseUrl","relativeImport","path","relative","dirname","bundle","legacySinglePageExportBundleAsync","platform","domRoot","encodeURI","splitChunks","env","EXPO_NO_BUNDLE_SPLITTING","mainModuleName","resolveRealEntryFilePath","mode","engine","undefined","serializerIncludeMaps","bytecode","reactCompiler","experiments","minify","html","serializeHtmlWithAssets","isExporting","resources","artifacts","template","getDomComponentHtml","serialAssets","map","a","filename","join","getFilesFromSerialAssets","set","contents","htmlOutputName","domComponentReference","nativeBundle","domComponentBundle","assetsMetadata","artifact","type","artifactAssetName","source","asset","assets","prefix","httpServerLocation","uri","name","regexp","RegExp","index","scales","findIndex","s","md5","fileHashes","replace","domJsAssetEntity","get","assert","htmlAssetEntity","toString","push","ext","htmlContent","htmlMd5","assetEntity"],"mappings":"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"}